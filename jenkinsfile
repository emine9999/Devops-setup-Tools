pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                script {
                    def html = '''<html>
  <body>
    <h1>Hello World</h1>
  </body>
</html>'''
                    writeFile file: 'index.html', text: html
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    def label = "app=hello-world"
                    def image = docker.build("hello-world")
                    image.inside {
                        sh 'cp /index.html /usr/share/nginx/html/index.html'
                    }
                    sh "kubectl run hello-world --image=hello-world --labels=${label} --port=80"
                    sh "kubectl expose deployment hello-world --type=NodePort --port=80"
                }
            }
        }
    }
}
