pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                script {
                    def html = '''<html>
  <body>
    <h1>Hello World</h1>
  </body>
</html>'''
                    writeFile file: 'index.html', text: html
                }
            }
        }
        stage('Docker Build and Deploy') {
            steps {
                script {
                    def label = "app=hello-world"
                    def image = docker.build("hello-world")

                    // Copy the index.html to the proper location in the image
                    image.inside {
                        sh 'cp /workspace/index.html /usr/share/nginx/html/index.html'
                    }

                    // Create a Deployment instead of a Pod
                    sh "kubectl create deployment hello-world --image=hello-world --labels=${label}"
                    sh "kubectl expose deployment hello-world --type=NodePort --port=80"
                }
            }
        }
    }
}
